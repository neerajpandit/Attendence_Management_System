import path from "path";
import fs from "fs/promises";
import clamav from "clamav.js";

const CLAMAV_PORT = 3310; // default port
const CLAMAV_HOST = "127.0.0.1"; // default host

const scanFileForMalware = async (req, res, next) => {
  if (!req.file) return next();

  const filePath = req.file.path;

  try {
    await new Promise((resolve, reject) => {
      clamav.ping(CLAMAV_PORT, CLAMAV_HOST, (err) => {
        if (err) return reject("ClamAV is not reachable");

        const stream = fs.createReadStream(filePath);
        clamav
          .createScanner(CLAMAV_PORT, CLAMAV_HOST)
          .scan(stream, (err, object, malicious) => {
            if (err) return reject(err);
            if (malicious) return reject(new Error("Malicious file detected"));
            resolve();
          });
      });
    });

    next();
  } catch (error) {
    await fs.unlink(filePath); // remove malicious file
    next(error); // pass error to error handler
  }
};

export { scanFileForMalware };
